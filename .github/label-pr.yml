name: Label Pull Requests

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze-and-label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              }
            );

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              }
            );

            const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
            const commitMessages = commits.map(c => c.commit.message);

            core.setOutput("commitMessages", JSON.stringify(commitMessages));
            core.setOutput("changes", totalChanges);
            core.setOutput("numCommits", commits.length);

      - name: Add size label
        uses: actions/github-script@v7
        with:
          script: |
            const size = parseInt(core.getInput("changes"));
            let label = "size/XS";
            if (size > 500) label = "size/XL";
            else if (size > 200) label = "size/L";
            else if (size > 100) label = "size/M";
            else if (size > 20) label = "size/S";

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });
        env:
          changes: ${{ steps.pr.outputs.changes }}

      - name: Add type labels from commits
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessages = JSON.parse(core.getInput("messages"));
            const labels = new Set();

            for (const msg of commitMessages) {
              if (/^feat/i.test(msg)) labels.add("type/feature");
              if (/^fix/i.test(msg)) labels.add("type/bug");
              if (/^docs/i.test(msg)) labels.add("type/docs");
              if (/^refactor/i.test(msg)) labels.add("type/refactor");
              if (/^chore/i.test(msg)) labels.add("type/chore");
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }
        env:
          messages: ${{ steps.pr.outputs.commitMessages }}

      - name: Post Commit Message Guide
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
ğŸ‘‹ PR ê°ì‚¬í•©ë‹ˆë‹¤!

ğŸ’¬ **ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„± ê°€ì´ë“œ (Conventional Commits)**:
- \`feat: ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€\`
- \`fix: ë²„ê·¸ ìˆ˜ì •\`
- \`docs: ë¬¸ì„œ ë³€ê²½\`
- \`refactor: ì½”ë“œ ë¦¬íŒ©í† ë§\`
- \`chore: ê¸°íƒ€ ë³€ê²½ì‚¬í•­\`

ğŸ”– ì‚¬ì´ì¦ˆ ë¼ë²¨ì€ ë³€ê²½ëœ ì¤„ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë¶€ì°©ë©ë‹ˆë‹¤.
            `
            });
